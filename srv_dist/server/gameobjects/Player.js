"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const Actor_1 = require("./Actor");
const WorldMap_1 = require("./WorldMap");
const Point_1 = require("../core/Point");
class Player extends Actor_1.Actor {
    constructor() {
        super(...arguments);
        this.tag = "player";
        this.grounded = false;
        this.climbing = true;
    }
    update(state, controls) {
        if (this.grounded)
            this.climbing = false;
        if (!this.climbing) {
            this.velocity.y += 0.78;
            if (controls.jump && this.grounded) {
                this.velocity.y = -12;
            }
            if (controls.left) {
                this.velocity.x = -5;
            }
            else if (controls.right) {
                this.velocity.x = 5;
            }
            else {
                this.velocity.x = 0;
            }
            if (controls.up && state.world.isOnLadder(this)) {
                this.velocity.x = 0;
                this.velocity.y = 0;
                this.climbing = true;
                this.horizontalCenter = Math.floor(this.horizontalCenter / WorldMap_1.TILE_SIZE) * WorldMap_1.TILE_SIZE + WorldMap_1.TILE_SIZE / 2;
            }
        }
        if (this.climbing) {
            this.climbingUpdate(state, controls);
        }
        let move = state.world.move(this);
        this.grounded = move.collisions[1] === 1;
        if (move.collisions[0] !== 0) {
            this.velocity.x = 0;
        }
        if (move.collisions[1] !== 0) {
            this.velocity.y = 0;
        }
        let oldPosition = this.position;
        this.position = move.position.offset(this.width / 2, this.height);
        if (this.climbing && !state.world.isOnLadder(this) && this.velocity.y < 0) {
            if (!controls.left && !controls.right) {
                this.position = new Point_1.Point(oldPosition.x, Math.floor(oldPosition.y / WorldMap_1.TILE_SIZE) * WorldMap_1.TILE_SIZE + 1);
            }
            else {
                this.position = new Point_1.Point(this.position.x, Math.ceil(this.position.y / WorldMap_1.TILE_SIZE) * WorldMap_1.TILE_SIZE - 1);
                this.velocity.y = -8.5;
                this.climbing = false;
            }
        }
        return this;
    }
    climbingUpdate(state, controls) {
        if (!state.world.isOnLadder(this)) {
            this.climbing = false;
        }
        if (controls.up) {
            this.velocity.y = -5;
        }
        else if (controls.down) {
            this.velocity.y = 5;
        }
        else {
            this.velocity.y = 0;
        }
        if (controls.jump) {
            if (controls.down) {
                this.velocity.y = 0;
            }
            else {
                if (!controls.up) {
                    this.velocity.y = -8;
                }
            }
            this.climbing = false;
        }
        if (this.grounded) {
            this.climbing = false;
        }
    }
}
exports.Player = Player;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGxheWVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vc2VydmVyL2dhbWVvYmplY3RzL1BsYXllci50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUdBLG1DQUFnQztBQUNoQyx5Q0FBdUM7QUFDdkMseUNBQXNDO0FBR3RDLFlBQW9CLFNBQVEsYUFBSztJQUFqQzs7UUFDVyxRQUFHLEdBQUcsUUFBUSxDQUFDO1FBQ2YsYUFBUSxHQUFHLEtBQUssQ0FBQztRQUNqQixhQUFRLEdBQUcsSUFBSSxDQUFDO0lBNkUzQixDQUFDO0lBM0VVLE1BQU0sQ0FBQyxLQUFnQixFQUFFLFFBQXFCO1FBQ2pELElBQUksSUFBSSxDQUFDLFFBQVE7WUFBRSxJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztRQUV6QyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRTtZQUNoQixJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUM7WUFFeEIsSUFBSSxRQUFRLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7Z0JBQ2hDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDO2FBQ3pCO1lBQ0QsSUFBSSxRQUFRLENBQUMsSUFBSSxFQUFFO2dCQUNmLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2FBQ3hCO2lCQUFNLElBQUksUUFBUSxDQUFDLEtBQUssRUFBRTtnQkFDdkIsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQ3ZCO2lCQUFNO2dCQUNILElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQzthQUN2QjtZQUNELElBQUksUUFBUSxDQUFDLEVBQUUsSUFBSSxLQUFLLENBQUMsS0FBSyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsRUFBRTtnQkFDN0MsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFD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QUM7U0FDdkI7UUFDRCxJQUFJLFFBQVEsQ0FBQyxJQUFJLEVBQUU7WUFDZixJQUFJLFFBQVEsQ0FBQyxJQUFJLEVBQUU7Z0JBQ2YsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2FBQ3ZCO2lCQUFNO2dCQUNILElBQUksQ0FBQyxRQUFRLENBQUMsRUFBRSxFQUFFO29CQUNkLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO2lCQUN4QjthQUNKO1lBQ0QsSUFBSSxDQUFDLFFBQVEsR0FBRyxLQUFLLENBQUM7U0FDekI7UUFDRCxJQUFJLElBQUksQ0FBQyxRQUFRLEVBQUU7WUFDZixJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQztTQUN6QjtJQUNMLENBQUM7Q0FDSjtBQWhGRCx3QkFnRkMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBEeW5hbWljT2JqZWN0IH0gZnJvbSBcIi4uL0R5bmFtaWNPYmplY3RcIlxyXG5pbXBvcnQgeyBHYW1lU3RhdGUgfSBmcm9tIFwiLi4vR2FtZVN0YXRlXCI7XHJcbmltcG9ydCB7IENvbnRyb2xQYWNrIH0gZnJvbSBcIi4uL0NvbnRyb2xQYWNrXCI7XHJcbmltcG9ydCB7IEFjdG9yIH0gZnJvbSBcIi4vQWN0b3JcIjtcclxuaW1wb3J0IHsgVElMRV9TSVpFIH0gZnJvbSBcIi4vV29ybGRNYXBcIjtcclxuaW1wb3J0IHsgUG9pbnQgfSBmcm9tIFwiLi4vY29yZS9Qb2ludFwiO1xyXG5pbXBvcnQgeyBFTkdJTkVfTUVUSE9EX0VDREggfSBmcm9tIFwiY29uc3RhbnRzXCI7XHJcblxyXG5leHBvcnQgY2xhc3MgUGxheWVyIGV4dGVuZHMgQWN0b3IgaW1wbGVtZW50cyBEeW5hbWljT2JqZWN0PEdhbWVTdGF0ZSwgQ29udHJvbFBhY2s+IHtcclxuICAgIHB1YmxpYyB0YWcgPSBcInBsYXllclwiO1xyXG4gICAgcHVibGljIGdyb3VuZGVkID0gZmFsc2U7XHJcbiAgICBwdWJsaWMgY2xpbWJpbmcgPSB0cnVlO1xyXG5cclxuICAgIHB1YmxpYyB1cGRhdGUoc3RhdGU6IEdhbWVTdGF0ZSwgY29udHJvbHM6IENvbnRyb2xQYWNrKSB7XHJcbiAgICAgICAgaWYgKHRoaXMuZ3JvdW5kZWQpIHRoaXMuY2xpbWJpbmcgPSBmYWxzZTtcclxuXHJcbiAgICAgICAgaWYgKCF0aGlzLmNsaW1iaW5nKSB7XHJcbiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSArPSAwLjc4O1xyXG4gICAgICAgICAgICBcclxuICAgICAgICAgICAgaWYgKGNvbnRyb2xzLmp1bXAgJiYgdGhpcy5ncm91bmRlZCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ID0gLTEyO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIGlmIChjb250cm9scy5sZWZ0KSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnggPSAtNTtcclxuICAgICAgICAgICAgfSBlbHNlIGlmIChjb250cm9scy5yaWdodCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS54ID0gNTtcclxuICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCA9IDA7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgaWYgKGNvbnRyb2xzLnVwICYmIHN0YXRlLndvcmxkLmlzT25MYWRkZXIodGhpcykpIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueCA9IDA7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgPSAwO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5jbGltYmluZyA9IHRydWU7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmhvcml6b250YWxDZW50ZXIgPSBNYXRoLmZsb29yKHRoaXMuaG9yaXpvbnRhbENlbnRlciAvIFRJTEVfU0laRSkgKiBUSUxFX1NJWkUgKyBUSUxFX1NJWkUgLyAyO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgfVxyXG5cclxuICAgICAgICBpZiAodGhpcy5jbGltYmluZykge1xyXG4gICAgICAgICAgICB0aGlzLmNsaW1iaW5nVXBkYXRlKHN0YXRlLCBjb250cm9scyk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIFxyXG4gICAgICAgIGxldCBtb3ZlID0gc3RhdGUud29ybGQubW92ZSh0aGlzKTtcclxuICAgICAgICB0aGlzLmdyb3VuZGVkID0gbW92ZS5jb2xsaXNpb25zWzFdID09PSAxO1xyXG4gICAgICAgIGlmIChtb3ZlLmNvbGxpc2lvbnNbMF0gIT09IDApIHtcclxuICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS54ID0gMDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG1vdmUuY29sbGlzaW9uc1sxXSAhPT0gMCkge1xyXG4gICAgICAgICAgICB0aGlzLnZlbG9jaXR5LnkgPSAwO1xyXG4gICAgICAgIH1cclxuICAgICAgICBsZXQgb2xkUG9zaXRpb24gPSB0aGlzLnBvc2l0aW9uO1xyXG4gICAgICAgIHRoaXMucG9zaXRpb24gPSBtb3ZlLnBvc2l0aW9uLm9mZnNldCh0aGlzLndpZHRoIC8gMiwgdGhpcy5oZWlnaHQpO1xyXG4gICAgICAgIGlmICh0aGlzLmNsaW1iaW5nICYmICFzdGF0ZS53b3JsZC5pc09uTGFkZGVyKHRoaXMpICYmIHRoaXMudmVsb2NpdHkueSA8IDApIHtcclxuICAgICAgICAgICAgaWYgKCFjb250cm9scy5sZWZ0ICYmICFjb250cm9scy5yaWdodCkge1xyXG4gICAgICAgICAgICAgICAgdGhpcy5wb3NpdGlvbiA9IG5ldyBQb2ludChvbGRQb3NpdGlvbi54LCBNYXRoLmZsb29yKG9sZFBvc2l0aW9uLnkgLyBUSUxFX1NJWkUpICogVElMRV9TSVpFICsgMSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICB0aGlzLnBvc2l0aW9uID0gbmV3IFBvaW50KHRoaXMucG9zaXRpb24ueCwgTWF0aC5jZWlsKHRoaXMucG9zaXRpb24ueSAvIFRJTEVfU0laRSkgKiBUSUxFX1NJWkUgLSAxKTtcclxuICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSA9IC04LjU7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmNsaW1iaW5nID0gZmFsc2U7XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICB9XHJcbiAgICAgICAgcmV0dXJuIHRoaXM7XHJcbiAgICB9XHJcblxyXG4gICAgcHJpdmF0ZSBjbGltYmluZ1VwZGF0ZShzdGF0ZTogR2FtZVN0YXRlLCBjb250cm9sczogQ29udHJvbFBhY2spIHtcclxuICAgICAgICBpZiAoIXN0YXRlLndvcmxkLmlzT25MYWRkZXIodGhpcykpIHtcclxuICAgICAgICAgICAgdGhpcy5jbGltYmluZyA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAoY29udHJvbHMudXApIHtcclxuICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ID0gLTU7XHJcbiAgICAgICAgfSBlbHNlIGlmIChjb250cm9scy5kb3duKSB7XHJcbiAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSA9IDU7XHJcbiAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ID0gMDtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKGNvbnRyb2xzLmp1bXApIHtcclxuICAgICAgICAgICAgaWYgKGNvbnRyb2xzLmRvd24pIHtcclxuICAgICAgICAgICAgICAgIHRoaXMudmVsb2NpdHkueSA9IDA7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgICBpZiAoIWNvbnRyb2xzLnVwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdGhpcy52ZWxvY2l0eS55ID0gLTg7XHJcbiAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgdGhpcy5jbGltYmluZyA9IGZhbHNlO1xyXG4gICAgICAgIH1cclxuICAgICAgICBpZiAodGhpcy5ncm91bmRlZCkge1xyXG4gICAgICAgICAgICB0aGlzLmNsaW1iaW5nID0gZmFsc2U7XHJcbiAgICAgICAgfVxyXG4gICAgfVxyXG59Il19