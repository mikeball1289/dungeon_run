"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const DunGen_1 = require("../../common/DunGen");
const Point_1 = require("../core/Point");
exports.TILE_SIZE = 32;
const EPSILON = 0.001;
class WorldMap {
    constructor(dungeon) {
        this.dungeon = dungeon;
    }
    move(actor) {
        let collisions = [0, 0];
        let position = new Point_1.Point(actor.left, actor.top);
        let velocity = actor.velocity.copy();
        let xv = velocity.x;
        while (xv !== 0) {
            let move = Math.max(Math.min(exports.TILE_SIZE, xv), -exports.TILE_SIZE);
            position.x += move;
            xv -= move;
            let left = Math.floor(position.x / exports.TILE_SIZE);
            let right = Math.floor((position.x + actor.width) / exports.TILE_SIZE);
            let top = Math.floor(position.y / exports.TILE_SIZE);
            let bottom = Math.floor((position.y + actor.height) / exports.TILE_SIZE);
            for (let i = top; i <= bottom; i++) {
                if (this.dungeon.tiles.get(left, i) === DunGen_1.ETiles.WALL || this.dungeon.tiles.get(right, i) === DunGen_1.ETiles.WALL) {
                    if (move > 0) {
                        position.x = right * 32 - EPSILON - actor.width;
                        collisions[0] = 1;
                    }
                    else {
                        position.x = left * 32 + 32 + EPSILON;
                        collisions[0] = -1;
                    }
                    xv = 0;
                    break;
                }
            }
        }
        let yv = velocity.y;
        while (yv !== 0) {
            let move = Math.max(Math.min(exports.TILE_SIZE, yv), -exports.TILE_SIZE);
            position.y += move;
            yv -= move;
            let left = Math.floor(position.x / exports.TILE_SIZE);
            let right = Math.floor((position.x + actor.width) / exports.TILE_SIZE);
            let top = Math.floor(position.y / exports.TILE_SIZE);
            let bottom = Math.floor((position.y + actor.height) / exports.TILE_SIZE);
            for (let i = left; i <= right; i++) {
                if (this.dungeon.tiles.get(i, top) === DunGen_1.ETiles.WALL || this.dungeon.tiles.get(i, bottom) === DunGen_1.ETiles.WALL) {
                    if (move > 0) {
                        position.y = bottom * 32 - EPSILON - actor.height;
                        collisions[1] = 1;
                    }
                    else {
                        position.y = top * 32 + 32 + EPSILON;
                        collisions[1] = -1;
                    }
                    yv = 0;
                    break;
                }
            }
        }
        return {
            position,
            collisions,
        };
    }
    isOnLadder(actor) {
        let center = Math.floor(actor.horizontalCenter / exports.TILE_SIZE);
        let top = Math.floor(actor.top / exports.TILE_SIZE);
        let bottom = Math.floor(actor.bottom / exports.TILE_SIZE);
        return (this.dungeon.tiles.get(center, top) === DunGen_1.ETiles.LADDER || this.dungeon.tiles.get(center, bottom) === DunGen_1.ETiles.LADDER);
    }
}
exports.WorldMap = WorldMap;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiV29ybGRNYXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi9zZXJ2ZXIvZ2FtZW9iamVjdHMvV29ybGRNYXAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxnREFBc0Q7QUFFdEQseUNBQXNDO0FBRXpCLFFBQUEsU0FBUyxHQUFHLEVBQUUsQ0FBQztBQUM1QixNQUFNLE9BQU8sR0FBRyxLQUFLLENBQUM7QUFFdEI7SUFFSSxZQUFtQixPQUFnQjtRQUFoQixZQUFPLEdBQVAsT0FBTyxDQUFTO0lBRW5DLENBQUM7SUFFTSxJQUFJLENBQUMsS0FBWTtRQUNwQixJQUFJLFVBQVUsR0FBcUIsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFFMUMsSUFBSSxRQUFRLEdBQUcsSUFBSSxhQUFLLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUM7UUFDaEQsSUFBSSxRQUFRLEdBQUcsS0FBSyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUNyQyxJQUFJLEVBQUUsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDO1FBQ3BCLE9BQU8sRUFBRSxLQUFLLENBQUMsRUFBRTtZQUNiLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxpQkFBUyxFQUFFLEVBQUUsQ0FBQyxFQUFFLENBQUMsaUJBQVMsQ0FBQyxDQUFDO1lBQ3pELFFBQVEsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDO1lBQ25CLEVBQUUsSUFBSSxJQUFJLENBQUM7WUFDWCxJQUFJLElBQUksR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsaUJBQVMsQ0FBQyxDQUFDO1lBQzlDLElBQUksS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxpQkFBUyxDQUFDLENBQUM7WUFDL0QsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQyxHQUFHLGlCQUFTLENBQUMsQ0FBQztZQUM3QyxJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUMsR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsaUJBQVMsQ0FBQyxDQUFDO1lBQ2pFLEtBQUssSUFBSSxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUMsSUFBSSxNQUFNLEVBQUUsQ0FBQyxFQUFHLEVBQUU7Z0JBQ2pDLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUMsS0FBSyxlQUFNLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFDLEtBQUssZUFBTSxDQUFDLElBQUksRUFBRTtvQkFDckcsSUFBSSxJQUFJLEdBQUcsQ0FBQyxFQUFFO3dCQUNWLFFBQVEsQ0FBQyxDQUFDLEdBQUcsS0FBSyxHQUFHLEVBQUUsR0FBRyxPQUFPLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQzt3QkFDaEQsVUFBVSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQztxQkFDckI7eUJBQU07d0JBQ0gsUUFBUSxDQUFDLENBQUMsR0FBRyxJQUFJLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxPQUFPLENBQUM7d0JBQ3RDLFVBQVUsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQztxQkFDdEI7b0JBQ0QsRUFBRSxHQUFHLENBQUMsQ0FBQztvQkFDUCxNQUFNO2lCQUNUO2FBQ0o7U0FDSjtRQUVELElBQUksRUFBRSxHQUFHLFFBQVEsQ0FBQyxDQUFDLENBQUM7UUFDcEIsT0FBTyxFQUFFLEtBQUssQ0FBQyxFQUFFO1lBQ2IsSUFBSSxJQUFJLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLGlCQUFTLEVBQUUsRUFBRSxDQUFDLEVBQUUsQ0FBQyxpQkFBUyxDQUFDLENBQUM7WUFDekQsUUFBUSxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUM7WUFDbkIsRUFBRSxJQUFJLElBQUksQ0FBQztZQUNYLElBQUksSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxDQUFDLENBQUMsR0FBRyxpQkFBUyxDQUFDLENBQUM7WUFDOUMsSUFBSSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsS0FBSyxDQUFDLEtBQUssQ0FBQyxHQUFHLGlCQUFTLENBQUMsQ0FBQztZQUMvRCxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDLEdBQUcsaUJBQVMsQ0FBQyxDQUFDO1lBQzdDLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxpQkFBUyxDQUFDLENBQUM7WUFDakUsS0FBSyxJQUFJLENBQUMsR0FBRyxJQUFJLEVBQUUsQ0FBQyxJQUFJLEtBQUssRUFBRSxDQUFDLEVBQUcsRUFBRTtnQkFDakMsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxLQUFLLGVBQU0sQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxNQUFNLENBQUMsS0FBSyxlQUFNLENBQUMsSUFBSSxFQUFFO29CQUNyRyxJQUFJLElBQUksR0FBRyxDQUFDLEVBQUU7d0JBQ1YsUUFBUSxDQUFDLENBQUMsR0FBRyxNQUFNLEdBQUcsRUFBRSxHQUFHLE9BQU8sR0FBRyxLQUFLLENBQUMsTUFBTSxDQUFDO3dCQUNsRCxVQUFVLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDO3FCQUNyQjt5QkFBTTt3QkFDSCxRQUFRLENBQUMsQ0FBQyxHQUFHLEdBQUcsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLE9BQU8sQ0FBQzt3QkFDckMsVUFBVSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO3FCQUN0QjtvQkFDRCxFQUFFLEdBQUcsQ0FBQyxDQUFDO29CQUNQLE1BQU07aUJBQ1Q7YUFDSjtTQUNKO1FBRUQsT0FBTztZQUNILFFBQVE7WUFDUixVQUFVO1NBQ2IsQ0FBQztJQUNOLENBQUM7SUFFTSxVQUFVLENBQUMsS0FBWTtRQUMxQixJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxnQkFBZ0IsR0FBRyxpQkFBUyxDQUFDLENBQUM7UUFDNUQsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsR0FBRyxHQUFHLGlCQUFTLENBQUMsQ0FBQztRQUM1QyxJQUFJLE1BQU0sR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxNQUFNLEdBQUcsaUJBQVMsQ0FBQyxDQUFDO1FBRWxELE9BQU8sQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxLQUFLLGVBQU0sQ0FBQyxNQUFNLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsS0FBSyxlQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7SUFDL0gsQ0FBQztDQUVKO0FBekVELDRCQXlFQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IER1bmdlb24sIEVUaWxlcyB9IGZyb20gXCIuLi8uLi9jb21tb24vRHVuR2VuXCI7XHJcbmltcG9ydCB7IEFjdG9yIH0gZnJvbSBcIi4vQWN0b3JcIjtcclxuaW1wb3J0IHsgUG9pbnQgfSBmcm9tIFwiLi4vY29yZS9Qb2ludFwiO1xyXG5cclxuZXhwb3J0IGNvbnN0IFRJTEVfU0laRSA9IDMyO1xyXG5jb25zdCBFUFNJTE9OID0gMC4wMDE7XHJcblxyXG5leHBvcnQgY2xhc3MgV29ybGRNYXAge1xyXG5cclxuICAgIGNvbnN0cnVjdG9yKHB1YmxpYyBkdW5nZW9uOiBEdW5nZW9uKSB7XHJcblxyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBtb3ZlKGFjdG9yOiBBY3Rvcik6IHsgcG9zaXRpb246IFBvaW50LCBjb2xsaXNpb25zOiBbbnVtYmVyLCBudW1iZXJdIH0ge1xyXG4gICAgICAgIGxldCBjb2xsaXNpb25zOiBbbnVtYmVyLCBudW1iZXJdID0gWzAsIDBdO1xyXG5cclxuICAgICAgICBsZXQgcG9zaXRpb24gPSBuZXcgUG9pbnQoYWN0b3IubGVmdCwgYWN0b3IudG9wKTtcclxuICAgICAgICBsZXQgdmVsb2NpdHkgPSBhY3Rvci52ZWxvY2l0eS5jb3B5KCk7XHJcbiAgICAgICAgbGV0IHh2ID0gdmVsb2NpdHkueDtcclxuICAgICAgICB3aGlsZSAoeHYgIT09IDApIHtcclxuICAgICAgICAgICAgbGV0IG1vdmUgPSBNYXRoLm1heChNYXRoLm1pbihUSUxFX1NJWkUsIHh2KSwgLVRJTEVfU0laRSk7XHJcbiAgICAgICAgICAgIHBvc2l0aW9uLnggKz0gbW92ZTtcclxuICAgICAgICAgICAgeHYgLT0gbW92ZTtcclxuICAgICAgICAgICAgbGV0IGxlZnQgPSBNYXRoLmZsb29yKHBvc2l0aW9uLnggLyBUSUxFX1NJWkUpO1xyXG4gICAgICAgICAgICBsZXQgcmlnaHQgPSBNYXRoLmZsb29yKChwb3NpdGlvbi54ICsgYWN0b3Iud2lkdGgpIC8gVElMRV9TSVpFKTtcclxuICAgICAgICAgICAgbGV0IHRvcCA9IE1hdGguZmxvb3IocG9zaXRpb24ueSAvIFRJTEVfU0laRSk7XHJcbiAgICAgICAgICAgIGxldCBib3R0b20gPSBNYXRoLmZsb29yKChwb3NpdGlvbi55ICsgYWN0b3IuaGVpZ2h0KSAvIFRJTEVfU0laRSk7XHJcbiAgICAgICAgICAgIGZvciAobGV0IGkgPSB0b3A7IGkgPD0gYm90dG9tOyBpICsrKSB7XHJcbiAgICAgICAgICAgICAgICBpZiAodGhpcy5kdW5nZW9uLnRpbGVzLmdldChsZWZ0LCBpKSA9PT0gRVRpbGVzLldBTEwgfHwgdGhpcy5kdW5nZW9uLnRpbGVzLmdldChyaWdodCwgaSkgPT09IEVUaWxlcy5XQUxMKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYgKG1vdmUgPiAwKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uLnggPSByaWdodCAqIDMyIC0gRVBTSUxPTiAtIGFjdG9yLndpZHRoO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2xsaXNpb25zWzBdID0gMTtcclxuICAgICAgICAgICAgICAgICAgICB9IGVsc2Uge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBwb3NpdGlvbi54ID0gbGVmdCAqIDMyICsgMzIgKyBFUFNJTE9OO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2xsaXNpb25zWzBdID0gLTE7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHh2ID0gMDtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICBsZXQgeXYgPSB2ZWxvY2l0eS55O1xyXG4gICAgICAgIHdoaWxlICh5diAhPT0gMCkge1xyXG4gICAgICAgICAgICBsZXQgbW92ZSA9IE1hdGgubWF4KE1hdGgubWluKFRJTEVfU0laRSwgeXYpLCAtVElMRV9TSVpFKTtcclxuICAgICAgICAgICAgcG9zaXRpb24ueSArPSBtb3ZlO1xyXG4gICAgICAgICAgICB5diAtPSBtb3ZlO1xyXG4gICAgICAgICAgICBsZXQgbGVmdCA9IE1hdGguZmxvb3IocG9zaXRpb24ueCAvIFRJTEVfU0laRSk7XHJcbiAgICAgICAgICAgIGxldCByaWdodCA9IE1hdGguZmxvb3IoKHBvc2l0aW9uLnggKyBhY3Rvci53aWR0aCkgLyBUSUxFX1NJWkUpO1xyXG4gICAgICAgICAgICBsZXQgdG9wID0gTWF0aC5mbG9vcihwb3NpdGlvbi55IC8gVElMRV9TSVpFKTtcclxuICAgICAgICAgICAgbGV0IGJvdHRvbSA9IE1hdGguZmxvb3IoKHBvc2l0aW9uLnkgKyBhY3Rvci5oZWlnaHQpIC8gVElMRV9TSVpFKTtcclxuICAgICAgICAgICAgZm9yIChsZXQgaSA9IGxlZnQ7IGkgPD0gcmlnaHQ7IGkgKyspIHtcclxuICAgICAgICAgICAgICAgIGlmICh0aGlzLmR1bmdlb24udGlsZXMuZ2V0KGksIHRvcCkgPT09IEVUaWxlcy5XQUxMIHx8IHRoaXMuZHVuZ2Vvbi50aWxlcy5nZXQoaSwgYm90dG9tKSA9PT0gRVRpbGVzLldBTEwpIHtcclxuICAgICAgICAgICAgICAgICAgICBpZiAobW92ZSA+IDApIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb24ueSA9IGJvdHRvbSAqIDMyIC0gRVBTSUxPTiAtIGFjdG9yLmhlaWdodDtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY29sbGlzaW9uc1sxXSA9IDE7XHJcbiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb24ueSA9IHRvcCAqIDMyICsgMzIgKyBFUFNJTE9OO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBjb2xsaXNpb25zWzFdID0gLTE7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgICAgIHl2ID0gMDtcclxuICAgICAgICAgICAgICAgICAgICBicmVhaztcclxuICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgfVxyXG4gICAgICAgIH1cclxuICAgICAgICBcclxuICAgICAgICByZXR1cm4ge1xyXG4gICAgICAgICAgICBwb3NpdGlvbixcclxuICAgICAgICAgICAgY29sbGlzaW9ucyxcclxuICAgICAgICB9O1xyXG4gICAgfVxyXG5cclxuICAgIHB1YmxpYyBpc09uTGFkZGVyKGFjdG9yOiBBY3Rvcik6IGJvb2xlYW4ge1xyXG4gICAgICAgIGxldCBjZW50ZXIgPSBNYXRoLmZsb29yKGFjdG9yLmhvcml6b250YWxDZW50ZXIgLyBUSUxFX1NJWkUpO1xyXG4gICAgICAgIGxldCB0b3AgPSBNYXRoLmZsb29yKGFjdG9yLnRvcCAvIFRJTEVfU0laRSk7XHJcbiAgICAgICAgbGV0IGJvdHRvbSA9IE1hdGguZmxvb3IoYWN0b3IuYm90dG9tIC8gVElMRV9TSVpFKTtcclxuXHJcbiAgICAgICAgcmV0dXJuICh0aGlzLmR1bmdlb24udGlsZXMuZ2V0KGNlbnRlciwgdG9wKSA9PT0gRVRpbGVzLkxBRERFUiB8fCB0aGlzLmR1bmdlb24udGlsZXMuZ2V0KGNlbnRlciwgYm90dG9tKSA9PT0gRVRpbGVzLkxBRERFUik7XHJcbiAgICB9XHJcblxyXG59Il19